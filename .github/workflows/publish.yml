# This workflow publishes the python package to PyPI and DockerHub.
#
# Triggers:
# - release: published - When user clicks "Publish" on a draft release (downloads pre-built assets)
#
# Authentication: This workflow expects GitHub OIDC for passwordless PyPI publishing.
# For more info: https://docs.pypi.org/trusted-publishers/
#
# Note: We may want to rename this file at some point. However, if we rename the workflow file name,
# we have to also update the Trusted Publisher settings on PyPI.

name: CDK Publish
permissions:
  contents: read

on:
  release:
    types: [published]

jobs:
  publish_cdk:
    name: Publish CDK version to PyPI
    runs-on: ubuntu-24.04
    permissions:
      id-token: write
      contents: read
    environment:
      name: PyPi
      url: https://pypi.org/p/airbyte-cdk/
    env:
      VERSION: ${{ github.event.release.tag_name }}
    steps:
      - name: Download release assets
        uses: robinraju/release-downloader@v1.12
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "*"
          out-file-path: dist

      - name: Publish to PyPI
        uses: pypa/gh-action-pypi-publish@v1.12.4

  publish_sdm:
    name: Publish SDM to DockerHub
    runs-on: ubuntu-24.04
    environment:
      name: DockerHub
      url: https://hub.docker.com/r/airbyte/source-declarative-manifest/tags
    env:
      VERSION: ${{ github.event.release.tag_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release assets
        uses: robinraju/release-downloader@v1.12
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "*"
          out-file-path: dist

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: "Check for existing tag (version: ${{ env.VERSION }} )"
        uses: ./.github/actions/check-docker-tag
        with:
          image_name: airbyte/source-declarative-manifest
          tag: ${{ env.VERSION }}

      - name: "Build and push (version tag: ${{ env.VERSION }})"
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            airbyte/source-declarative-manifest:${{ env.VERSION }}

      - name: Build and push ('latest' tag)
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            airbyte/source-declarative-manifest:latest

  publish_manifest_server:
    name: Publish Manifest Server to DockerHub
    runs-on: ubuntu-24.04
    environment:
      name: DockerHub
      url: https://hub.docker.com/r/airbyte/manifest-server/tags
    env:
      VERSION: ${{ github.event.release.tag_name }}

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release assets
        uses: robinraju/release-downloader@v1.12
        with:
          tag: ${{ github.event.release.tag_name }}
          fileName: "*"
          out-file-path: dist

      - name: Set up QEMU for multi-platform builds
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_HUB_USERNAME }}
          password: ${{ secrets.DOCKER_HUB_PASSWORD }}

      - name: "Check for existing tag (version: ${{ env.VERSION }} )"
        uses: ./.github/actions/check-docker-tag
        with:
          image_name: airbyte/manifest-server
          tag: ${{ env.VERSION }}

      - name: "Build and push (version tag: ${{ env.VERSION }})"
        uses: docker/build-push-action@v5
        with:
          context: .
          file: airbyte_cdk/manifest_server/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            airbyte/manifest-server:${{ env.VERSION }}

      - name: Build and push ('latest' tag)
        uses: docker/build-push-action@v5
        with:
          context: .
          file: airbyte_cdk/manifest_server/Dockerfile
          platforms: linux/amd64,linux/arm64
          push: true
          tags: |
            airbyte/manifest-server:latest

  update-connector-builder:
    # Create a PR against the Builder, to update the CDK version that it uses.
    # In the future, Builder may use the SDM docker image instead of the Python CDK package.
    name: Bump Connector Builder CDK version
    environment:
      name: Connector Builder
      url: https://github.com/airbytehq/airbyte-platform-internal/pulls?q=is%3Apr+automatic-cdk-release+
    needs:
      - publish_manifest_server
    env:
      VERSION: ${{ github.event.release.tag_name }}
    runs-on: ubuntu-24.04
    steps:
      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@v2
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte-platform-internal"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}
      - name: Checkout Airbyte Platform Internal
        uses: actions/checkout@v4
        with:
          repository: airbytehq/airbyte-platform-internal
          token: ${{ steps.get-app-token.outputs.token }}
      - name: Update Builder's CDK version to ${{ env.VERSION }}
        # The manifest-server Docker image already includes the CDK version.
        # We just need to update the image tag in the Helm values file.
        run: |
          set -euo pipefail
          VALUES_FILE="oss/charts/v2/airbyte/values.yaml"
          # Get the current manifest-server tag from the values.yaml file
          PREVIOUS_VERSION=$(grep -A15 "^manifestServer:" "$VALUES_FILE" | grep -A4 "image:" | grep "tag:" | awk '{print $2}')
          echo "Previous version: ${PREVIOUS_VERSION}"
          echo "New version: ${VERSION}"
          # Update the manifest-server tag in the Helm values file (preserves formatting)
          sed -i "/^manifestServer:/,/^[a-zA-Z]/ s/tag: ${PREVIOUS_VERSION}/tag: ${VERSION}/" "$VALUES_FILE"
          # Also update the CDK version in the manifest-server-api build file
          sed -i "s/refs\/tags\/v${PREVIOUS_VERSION}/refs\/tags\/v${VERSION}/g" "oss/airbyte-api/manifest-server-api/build.gradle.kts"
          echo ${VERSION} > oss/airbyte-connector-builder-resources/CDK_VERSION
      - name: Create Pull Request
        id: create-pull-request
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ steps.get-app-token.outputs.token }}
          commit-message: "chore: update CDK version following release"
          title: "chore: update CDK version following release"
          body: This is an automatically generated PR triggered by a CDK release
          branch: automatic-cdk-release
          base: master
          delete-branch: true
      - name: Post success to Slack channel dev-connectors-extensibility
        uses: slackapi/slack-github-action@v1.23.0
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN_AIRBYTE_TEAM }}
        with:
          channel-id: C04J1M66D8B
          # Channel: #dev-connectors-extensibility-releases
          # Link (internal): https://airbytehq-team.slack.com/archives/C04J1M66D8B
          payload: |
            {
                "text": "A new version of Python CDK has been released!",
                "blocks": [
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "Python CDK `v${{ env.VERSION }}` has been <https://github.com/airbytehq/airbyte-python-cdk/releases|released>\n\n"
                        }
                    },
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "A PR has also been created for the <${{ steps.create-pull-request.outputs.pull-request-url }}|Connector Builder>\n"
                        }
                    },
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "See details on <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|GitHub>\n"
                        }
                    }
                ]
            }
      - name: Post failure to Slack channel dev-connectors-extensibility
        if: failure()
        uses: slackapi/slack-github-action@v1.23.0
        continue-on-error: true
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN_AIRBYTE_TEAM }}
        with:
          channel-id: C04J1M66D8B
          # Channel: #dev-connectors-extensibility-releases
          # Link (internal): https://airbytehq-team.slack.com/archives/C04J1M66D8B
          payload: |
            {
                "text": ":warning: A new version of Python CDK has been released but Connector Builder hasn't been automatically updated",
                "blocks": [
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "Python CDK `v${{ env.VERSION }}` has been <https://github.com/airbytehq/airbyte-python-cdk/releases|released>\n\n"
                        }
                    },
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": ":warning: Could not automatically create a PR for Connector Builder>\n"
                        }
                    },
                    {
                        "type": "section",
                        "text": {
                            "type": "mrkdwn",
                            "text": "See details on <https://github.com/${{github.repository}}/actions/runs/${{github.run_id}}|GitHub>\n"
                        }
                    }
                ]
            }

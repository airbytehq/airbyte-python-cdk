name: On-Demand Prerelease

# Minimal permissions for security (addresses GitHub Advanced Security feedback)
permissions:
  contents: read
  pull-requests: write
  issues: write

on:
  workflow_dispatch:
    inputs:
      pr:
        description: "PR Number"
        type: string
        required: false
      comment-id:
        description: "Comment ID (Optional)"
        type: string
        required: false

jobs:
  prerelease-on-demand:
    name: Trigger Prerelease Publish
    runs-on: ubuntu-24.04
    steps:
      - name: Authenticate as GitHub App
        uses: actions/create-github-app-token@v2
        id: get-app-token
        with:
          owner: "airbytehq"
          repositories: "airbyte-python-cdk"
          app-id: ${{ secrets.OCTAVIA_BOT_APP_ID }}
          private-key: ${{ secrets.OCTAVIA_BOT_PRIVATE_KEY }}

      - name: Create URL to the run output
        id: vars
        run: echo "run-url=https://github.com/$GITHUB_REPOSITORY/actions/runs/$GITHUB_RUN_ID" >> $GITHUB_OUTPUT

      - name: Check that PR number is provided
        if: github.event.inputs.pr == ''
        run: |
          echo "Error: /prerelease command must be invoked on a pull request, not an issue."
          exit 1

      - name: Get PR info
        id: pr-info
        run: |
          PR_JSON=$(gh api repos/${{ github.repository }}/pulls/${{ github.event.inputs.pr }})
          HEAD_REF=$(echo "$PR_JSON" | jq -r .head.ref)
          HEAD_REPO=$(echo "$PR_JSON" | jq -r .head.repo.full_name)
          echo "head-ref=${HEAD_REF}" >> $GITHUB_OUTPUT
          echo "head-repo=${HEAD_REPO}" >> $GITHUB_OUTPUT
          echo "PR branch: ${HEAD_REF} from ${HEAD_REPO}"
        env:
          GH_TOKEN: ${{ steps.get-app-token.outputs.token }}

      - name: Check that PR is from this repository (not a fork)
        if: steps.pr-info.outputs.head-repo != github.repository
        run: |
          echo "Error: /prerelease only works for branches in this repository, not forks."
          echo "PR is from: ${{ steps.pr-info.outputs.head-repo }}"
          echo "Expected: ${{ github.repository }}"
          exit 1

      - name: Append comment with job run link
        if: github.event.inputs.comment-id
        id: first-comment-action
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ github.event.inputs.comment-id }}
          issue-number: ${{ github.event.inputs.pr }}
          body: |
            > **Prerelease Job Info**
            >
            > This job triggers the publish workflow with default arguments to create a prerelease.
            >
            > Prerelease job started... [Check job output.][1]

            [1]: ${{ steps.vars.outputs.run-url }}

      - name: Trigger publish workflow
        id: trigger-publish
        run: |
          # Trigger the publish workflow on the PR's head branch
          # Note: These defaults mirror the defaults in publish.yml and can be extended
          # to accept optional overrides via slash command arguments if needed in the future.
          gh workflow run publish.yml \
            --ref "${{ steps.pr-info.outputs.head-ref }}" \
            -f version="" \
            -f publish_to_pypi=true \
            -f publish_to_dockerhub=true \
            -f publish_manifest_server=true \
            -f update_connector_builder=false
        env:
          GH_TOKEN: ${{ steps.get-app-token.outputs.token }}

      - name: Get workflow run URL
        id: workflow-url
        run: |
          # Wait a moment for the workflow to be created
          sleep 5
          # Query for the most recent publish workflow run on the PR branch
          # Filter by branch to avoid race conditions with concurrent runs
          WORKFLOW_RUN_URL=$(gh run list \
            --workflow=publish.yml \
            --branch "${{ steps.pr-info.outputs.head-ref }}" \
            --limit=1 \
            --json url \
            --jq '.[0].url')
          
          if [ -z "$WORKFLOW_RUN_URL" ] || [ "$WORKFLOW_RUN_URL" = "null" ]; then
            echo "Warning: Could not find workflow run URL. Using fallback."
            WORKFLOW_RUN_URL="https://github.com/${{ github.repository }}/actions/workflows/publish.yml"
          fi
          
          echo "workflow-run-url=${WORKFLOW_RUN_URL}" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ steps.get-app-token.outputs.token }}

      - name: Append success comment
        if: github.event.inputs.comment-id
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.first-comment-action.outputs.comment-id }}
          reactions: hooray
          body: |
            > ✅ Prerelease workflow triggered successfully.
            >
            > View the publish workflow run: ${{ steps.workflow-url.outputs.workflow-run-url }}

      - name: Append failure comment
        if: failure() && github.event.inputs.comment-id
        uses: peter-evans/create-or-update-comment@v4
        with:
          comment-id: ${{ steps.first-comment-action.outputs.comment-id }}
          reactions: confused
          body: |
            > ❌ Failed to trigger prerelease workflow.
